---
import Layout from '../../../layouts/Layout.astro';
import ContactSection from '../../../components/sections/ContactSection.astro';
import SuccessStoriesPage from '../../../components/pages/SuccessStoriesPage.astro';
import { defaultLocale, getMessages, locales, type Locale } from '../../../i18n/config';
import { resolveLocale, getAlternateLinks, buildLocaleUrl } from '../../../i18n/utils';
import { successStoriesPageCopy } from '../../../data/pages';

export async function getStaticPaths() {
  return locales.map((locale) => ({
    params: { lang: locale },
  }));
}

const langParam = Astro.params.lang;

if (!langParam) {
  return Astro.redirect('/success-stories');
}

const locale = resolveLocale(langParam) as Locale;

if (locale !== langParam) {
  const target = locale === defaultLocale ? '/success-stories' : `/${locale}/success-stories`;
  return Astro.redirect(target);
}

if (locale === defaultLocale) {
  return Astro.redirect('/success-stories');
}

const messages = getMessages(locale);
const pageCopy = successStoriesPageCopy[locale];
const alternateLinks = getAlternateLinks(locale, Astro.url);

const languageSwitcher = {
  current: locale,
  options: locales.map((lang) => ({
    label: lang.toUpperCase(),
    value: lang,
    href: buildLocaleUrl(lang, Astro.url),
  })),
};

const collectionStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: pageCopy.meta.title,
  description: pageCopy.meta.description,
  hasPart: messages.successStories.recentProjects.items.map((item) => ({
    '@type': 'CreativeWork',
    name: item.description,
    datePublished: item.year,
  })),
};
---

<Layout
  locale={locale}
  messages={messages}
  alternateLinks={alternateLinks}
  languageSwitcher={languageSwitcher}
  pageMeta={pageCopy.meta}
  additionalStructuredData={[collectionStructuredData]}
>
  <SuccessStoriesPage
    successStories={messages.successStories}
    contact={messages.contact}
    footerContact={messages.footer.contact}
    copy={pageCopy}
    contactHref="#contact"
  />
  <ContactSection contact={messages.contact} phoneNumber={messages.footer.contact.phone} />
</Layout>
