---
import Section from '../ui/Section.astro';
import Container from '../ui/Container.astro';
import SectionHeading from '../ui/SectionHeading.astro';
import Button from '../ui/Button.astro';

interface Props {
  contact: {
    eyebrow: string;
    heading: string;
    subheading: string;
    form: {
      nameLabel: string;
      emailLabel: string;
      companyLabel: string;
      messageLabel: string;
      submitCta: string;
    };
    quickAction: {
      label: string;
      description: string;
      whatsappCta: string;
    };
  };
  phoneNumber: string;
}

const { contact, phoneNumber } = Astro.props satisfies Props;

const whatsappHref = `https://wa.me/${phoneNumber.replace(/[^+\d]/g, '')}`;
---

<Section id="contact" background="tint">
  <Container class="grid gap-12 lg:grid-cols-[1.1fr_1fr]">
    <div>
      <SectionHeading
        eyebrow={contact.eyebrow}
        title={contact.heading}
        description={contact.subheading}
      />
      <div
        class="relative mt-10 overflow-hidden rounded-[28px] border border-white/20 bg-[rgba(0,0,0,0)] p-8 backdrop-blur-2xl"
      >
        <form
          class="grid gap-6"
          method="post"
          action="/api/contact"
          data-contact-form
          data-success-message={contact.form.successMessage}
          data-error-message={contact.form.errorMessage}
        >
          <label class="block">
            <span class="text-xs font-medium uppercase tracking-[0.2em] text-white">
              {contact.form.nameLabel}
            </span>
            <input
              type="text"
              name="name"
              required
              class="mt-2 w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-white shadow-inner shadow-black/10 focus:border-coral-200/60 focus:outline-none focus:ring-2 focus:ring-coral-200/30"
            />
          </label>
          <label class="block">
            <span class="text-xs font-medium uppercase tracking-[0.2em] text-white">
              {contact.form.emailLabel}
            </span>
            <input
              type="email"
              name="email"
              required
              class="mt-2 w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-white shadow-inner shadow-black/10 focus:border-coral-200/60 focus:outline-none focus:ring-2 focus:ring-coral-200/30"
            />
          </label>
          <label class="block">
            <span class="text-xs font-medium uppercase tracking-[0.2em] text-white">
              {contact.form.companyLabel}
            </span>
            <input
              type="text"
              name="company"
              class="mt-2 w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-white shadow-inner shadow-black/10 focus:border-coral-200/60 focus:outline-none focus:ring-2 focus:ring-coral-200/30"
            />
          </label>
          <label class="block">
            <span class="text-xs font-medium uppercase tracking-[0.2em] text-white">
              {contact.form.messageLabel}
            </span>
            <textarea
              name="message"
              rows={4}
              required
              class="mt-2 w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-white shadow-inner shadow-black/10 focus:border-coral-200/60 focus:outline-none focus:ring-2 focus:ring-coral-200/30"
            ></textarea>
          </label>
          <Button type="submit" variant="primary" size="lg" class="justify-center">
            {contact.form.submitCta}
          </Button>
          <p
            class="text-sm font-medium text-emerald-200"
            data-contact-status
            role="status"
            aria-live="polite"
            hidden
          ></p>
        </form>
      </div>
    </div>
    <aside class="relative flex flex-col justify-center gap-6 overflow-hidden rounded-[28px] border border-white/20 bg-[rgba(0,0,0,0)] p-10 text-white backdrop-blur-2xl">
      <p class="text-xs font-semibold uppercase tracking-[0.25em] text-white">{contact.quickAction.label}</p>
      <p class="text-2xl font-display font-semibold leading-snug text-white">
        {contact.quickAction.description}
      </p>
      <Button
        variant="secondary"
        size="lg"
        href={whatsappHref}
        target="_blank"
        rel="noopener noreferrer"
        class="justify-center"
      >
        {contact.quickAction.whatsappCta}
      </Button>
    </aside>
  </Container>
</Section>

<script>
  const form = document.querySelector('[data-contact-form]');
  const statusEl = document.querySelector('[data-contact-status]');
  const submitButton = form?.querySelector('button[type="submit"]');

  const successMessage = form?.dataset.successMessage || 'Message sent.';
  const errorMessage =
    form?.dataset.errorMessage || 'Something went wrong. Please try again or email us directly.';

  const setStatus = (state, message) => {
    if (!statusEl) return;
    statusEl.hidden = false;
    statusEl.textContent = message;
    statusEl.classList.remove('text-emerald-200', 'text-rose-200');
    statusEl.classList.add(state === 'success' ? 'text-emerald-200' : 'text-rose-200');
  };

  const maybeShowRedirectStatus = () => {
    if (!statusEl) return;
    const params = new URLSearchParams(window.location.search);
    if (params.get('contact') === 'success') {
      setStatus('success', successMessage);
    }
  };

  maybeShowRedirectStatus();

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    statusEl?.setAttribute('hidden', 'true');

    try {
      submitButton?.setAttribute('disabled', 'true');
      submitButton?.classList.add('opacity-80');

      const response = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: { Accept: 'application/json' },
      });

      if (response.redirected) {
        window.location.href = response.url;
        return;
      }

      if (response.ok) {
        setStatus('success', successMessage);
        form.reset();
      } else {
        setStatus('error', errorMessage);
      }
    } catch (error) {
      console.error(error);
      setStatus('error', errorMessage);
    } finally {
      submitButton?.removeAttribute('disabled');
      submitButton?.classList.remove('opacity-80');
    }
  });
</script>
